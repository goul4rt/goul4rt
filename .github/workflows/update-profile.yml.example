name: Update Profile with Celebrations

# Workflow completo que atualiza README e Pacman com o mesmo tema
# Este Ã© um exemplo de como integrar ambos os sistemas

on:
  schedule:
    - cron: "0 0 * * *"  # Todo dia Ã  meia-noite UTC

  workflow_dispatch:

  push:
    branches:
    - main

jobs:
  update-profile:
    permissions:
      contents: write
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      # ========================================
      # SETUP
      # ========================================
      
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: ğŸ“… Show current date
        run: |
          echo "ğŸ“… Data atual: $(date '+%d/%m/%Y %H:%M:%S %Z')"
          echo "ğŸŒ Timezone: $(date '+%Z %z')"

      # ========================================
      # DETECÃ‡ÃƒO DE TEMA
      # ========================================

      - name: ğŸ¨ Detect celebration theme
        id: theme
        run: |
          echo "ğŸ¨ Detectando tema de celebraÃ§Ã£o..."
          
          # Gera tema Pacman
          python3 scripts/pacman_theme_generator.py
          
          # Extrai informaÃ§Ãµes
          THEME=$(python3 -c "import json; data=json.load(open('scripts/pacman_theme.json')); print(data['celebration'])")
          DESCRIPTION=$(python3 -c "import json; data=json.load(open('scripts/pacman_theme.json')); print(data['theme']['description'])")
          DATE=$(python3 -c "import json; data=json.load(open('scripts/pacman_theme.json')); print(data['date'])")
          
          # Salva outputs
          echo "current_theme=$THEME" >> $GITHUB_OUTPUT
          echo "theme_description=$DESCRIPTION" >> $GITHUB_OUTPUT
          echo "current_date=$DATE" >> $GITHUB_OUTPUT
          
          # Log bonito
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ‰ TEMA DETECTADO"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“› Nome: $THEME"
          echo "ğŸ“ DescriÃ§Ã£o: $DESCRIPTION"
          echo "ğŸ“… Data: $DATE"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""

      # ========================================
      # ATUALIZAÃ‡ÃƒO DO README
      # ========================================

      - name: ğŸ“ Generate celebration README
        run: |
          echo "ğŸ“ Gerando README com tema de celebraÃ§Ã£o..."
          python3 scripts/celebration_generator.py
          
          if [ -f README.md ]; then
            echo "âœ… README.md gerado com sucesso!"
            
            # Mostra preview das primeiras linhas
            echo ""
            echo "ğŸ“„ Preview do README:"
            head -n 5 README.md | sed 's/^/   /'
            echo "   ..."
          else
            echo "âŒ Erro ao gerar README.md"
            exit 1
          fi

      # ========================================
      # GERAÃ‡ÃƒO DO PACMAN
      # ========================================

      - name: ğŸ® Generate Pacman contribution graph
        uses: abozanona/pacman-contribution-graph@main
        # TODO: Substituir por seu fork quando estiver pronto:
        # uses: SEU_USUARIO/pacman-contribution-graph@main
        with:
          github_user_name: ${{ github.repository_owner }}
        continue-on-error: true

      # ========================================
      # COMMIT DAS MUDANÃ‡AS
      # ========================================

      - name: ğŸ“Š Check for changes
        id: check_changes
        run: |
          git diff --quiet README.md && echo "readme_changed=false" >> $GITHUB_OUTPUT || echo "readme_changed=true" >> $GITHUB_OUTPUT
          
          if [ -f dist/pacman-contribution-graph.svg ]; then
            echo "pacman_generated=true" >> $GITHUB_OUTPUT
          else
            echo "pacman_generated=false" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ’¾ Commit README changes
        if: steps.check_changes.outputs.readme_changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          THEME="${{ steps.theme.outputs.current_theme }}"
          
          if [ "$THEME" != "default" ]; then
            COMMIT_MSG="ğŸ‰ Update profile with $THEME theme"
          else
            COMMIT_MSG="ğŸ“ Update profile"
          fi
          
          git add README.md
          git commit -m "$COMMIT_MSG" || echo "No changes to commit"

      - name: ğŸš€ Push README to main
        if: steps.check_changes.outputs.readme_changed == 'true'
        run: |
          git push origin main || echo "Nothing to push"

      # ========================================
      # PUSH DO PACMAN SVG
      # ========================================

      - name: ğŸ“¤ Push Pacman to output branch
        if: steps.check_changes.outputs.pacman_generated == 'true'
        uses: crazy-max/ghaction-github-pages@v3.1.0
        with:
          target_branch: output
          build_dir: dist
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ========================================
      # RELATÃ“RIO FINAL
      # ========================================

      - name: ğŸ“Š Final report
        if: always()
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“Š RELATÃ“RIO DE ATUALIZAÃ‡ÃƒO"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ¨ Tema: ${{ steps.theme.outputs.current_theme }}"
          echo "ğŸ“ ${{ steps.theme.outputs.theme_description }}"
          echo "ğŸ“… Data: ${{ steps.theme.outputs.current_date }}"
          echo ""
          echo "ğŸ“ README atualizado: ${{ steps.check_changes.outputs.readme_changed }}"
          echo "ğŸ® Pacman gerado: ${{ steps.check_changes.outputs.pacman_generated }}"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          if [ "${{ steps.theme.outputs.current_theme }}" != "default" ]; then
            echo "ğŸ‰ CelebraÃ§Ã£o ativa! Seu perfil estÃ¡ temÃ¡tico!"
          else
            echo "ğŸ“… Sem celebraÃ§Ã£o hoje. Usando tema padrÃ£o."
          fi
          
          echo ""
          echo "ğŸ’¡ Dica: Para usar cores customizadas no Pacman:"
          echo "   1. FaÃ§a fork de abozanona/pacman-contribution-graph"
          echo "   2. Execute: python3 scripts/custom_pacman_generator.py"
          echo "   3. Commit as mudanÃ§as"
          echo "   4. Use seu fork neste workflow"
          echo ""
          echo "ğŸ“š Docs: scripts/WORKFLOW_INTEGRATION.md"

