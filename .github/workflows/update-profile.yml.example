name: Update Profile with Celebrations

# Workflow completo que atualiza README e Pacman com o mesmo tema
# Este é um exemplo de como integrar ambos os sistemas

on:
  schedule:
    - cron: "0 0 * * *"  # Todo dia à meia-noite UTC

  workflow_dispatch:

  push:
    branches:
    - main

jobs:
  update-profile:
    permissions:
      contents: write
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      # ========================================
      # SETUP
      # ========================================
      
      - name: 📥 Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: 🐍 Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: 📅 Show current date
        run: |
          echo "📅 Data atual: $(date '+%d/%m/%Y %H:%M:%S %Z')"
          echo "🌍 Timezone: $(date '+%Z %z')"

      # ========================================
      # DETECÇÃO DE TEMA
      # ========================================

      - name: 🎨 Detect celebration theme
        id: theme
        run: |
          echo "🎨 Detectando tema de celebração..."
          
          # Gera tema Pacman
          python3 scripts/pacman_theme_generator.py
          
          # Extrai informações
          THEME=$(python3 -c "import json; data=json.load(open('scripts/pacman_theme.json')); print(data['celebration'])")
          DESCRIPTION=$(python3 -c "import json; data=json.load(open('scripts/pacman_theme.json')); print(data['theme']['description'])")
          DATE=$(python3 -c "import json; data=json.load(open('scripts/pacman_theme.json')); print(data['date'])")
          
          # Salva outputs
          echo "current_theme=$THEME" >> $GITHUB_OUTPUT
          echo "theme_description=$DESCRIPTION" >> $GITHUB_OUTPUT
          echo "current_date=$DATE" >> $GITHUB_OUTPUT
          
          # Log bonito
          echo ""
          echo "═══════════════════════════════════════════════"
          echo "🎉 TEMA DETECTADO"
          echo "═══════════════════════════════════════════════"
          echo "📛 Nome: $THEME"
          echo "📝 Descrição: $DESCRIPTION"
          echo "📅 Data: $DATE"
          echo "═══════════════════════════════════════════════"
          echo ""

      # ========================================
      # ATUALIZAÇÃO DO README
      # ========================================

      - name: 📝 Generate celebration README
        run: |
          echo "📝 Gerando README com tema de celebração..."
          python3 scripts/celebration_generator.py
          
          if [ -f README.md ]; then
            echo "✅ README.md gerado com sucesso!"
            
            # Mostra preview das primeiras linhas
            echo ""
            echo "📄 Preview do README:"
            head -n 5 README.md | sed 's/^/   /'
            echo "   ..."
          else
            echo "❌ Erro ao gerar README.md"
            exit 1
          fi

      # ========================================
      # GERAÇÃO DO PACMAN
      # ========================================

      - name: 🎮 Generate Pacman contribution graph
        uses: abozanona/pacman-contribution-graph@main
        # TODO: Substituir por seu fork quando estiver pronto:
        # uses: SEU_USUARIO/pacman-contribution-graph@main
        with:
          github_user_name: ${{ github.repository_owner }}
        continue-on-error: true

      # ========================================
      # COMMIT DAS MUDANÇAS
      # ========================================

      - name: 📊 Check for changes
        id: check_changes
        run: |
          git diff --quiet README.md && echo "readme_changed=false" >> $GITHUB_OUTPUT || echo "readme_changed=true" >> $GITHUB_OUTPUT
          
          if [ -f dist/pacman-contribution-graph.svg ]; then
            echo "pacman_generated=true" >> $GITHUB_OUTPUT
          else
            echo "pacman_generated=false" >> $GITHUB_OUTPUT
          fi

      - name: 💾 Commit README changes
        if: steps.check_changes.outputs.readme_changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          THEME="${{ steps.theme.outputs.current_theme }}"
          
          if [ "$THEME" != "default" ]; then
            COMMIT_MSG="🎉 Update profile with $THEME theme"
          else
            COMMIT_MSG="📝 Update profile"
          fi
          
          git add README.md
          git commit -m "$COMMIT_MSG" || echo "No changes to commit"

      - name: 🚀 Push README to main
        if: steps.check_changes.outputs.readme_changed == 'true'
        run: |
          git push origin main || echo "Nothing to push"

      # ========================================
      # PUSH DO PACMAN SVG
      # ========================================

      - name: 📤 Push Pacman to output branch
        if: steps.check_changes.outputs.pacman_generated == 'true'
        uses: crazy-max/ghaction-github-pages@v3.1.0
        with:
          target_branch: output
          build_dir: dist
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ========================================
      # RELATÓRIO FINAL
      # ========================================

      - name: 📊 Final report
        if: always()
        run: |
          echo ""
          echo "═══════════════════════════════════════════════"
          echo "📊 RELATÓRIO DE ATUALIZAÇÃO"
          echo "═══════════════════════════════════════════════"
          echo "🎨 Tema: ${{ steps.theme.outputs.current_theme }}"
          echo "📝 ${{ steps.theme.outputs.theme_description }}"
          echo "📅 Data: ${{ steps.theme.outputs.current_date }}"
          echo ""
          echo "📝 README atualizado: ${{ steps.check_changes.outputs.readme_changed }}"
          echo "🎮 Pacman gerado: ${{ steps.check_changes.outputs.pacman_generated }}"
          echo "═══════════════════════════════════════════════"
          echo ""
          
          if [ "${{ steps.theme.outputs.current_theme }}" != "default" ]; then
            echo "🎉 Celebração ativa! Seu perfil está temático!"
          else
            echo "📅 Sem celebração hoje. Usando tema padrão."
          fi
          
          echo ""
          echo "💡 Dica: Para usar cores customizadas no Pacman:"
          echo "   1. Faça fork de abozanona/pacman-contribution-graph"
          echo "   2. Execute: python3 scripts/custom_pacman_generator.py"
          echo "   3. Commit as mudanças"
          echo "   4. Use seu fork neste workflow"
          echo ""
          echo "📚 Docs: scripts/WORKFLOW_INTEGRATION.md"

